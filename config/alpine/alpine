#!/bin/sh

cat <<EOF > bootstrap.start
#!/bin/sh
exec > /var/log/bootstrap.log 2>&1
echo "BOOTSTRAP START: \$(date)"

# Provide a minimal interfaces file for OpenRC
echo "--- Fixing networking config ---"
mkdir -p /etc/network
echo "auto lo" > /etc/network/interfaces
echo "iface lo inet loopback" >> /etc/network/interfaces
echo "auto eth0" >> /etc/network/interfaces
echo "iface eth0 inet dhcp" >> /etc/network/interfaces

# Ensure networking is up early for all dependencies
echo "--- Starting networking ---"
rc-service networking start || true

# do the system installation
setup-interfaces -a
setup-keymap us us
setup-timezone -i UTC
setup-ntp chrony || true

true >/etc/apk/repositories
setup-apkrepos -1

echo "--- Installing dependencies ---"
apk add bash curl iptables util-linux iproute2 coreutils ethtool e2fsprogs

# Increase limits
ulimit -n 65536

# Mount cgroups (k0s needs this)
echo "--- Mounting cgroups ---"
if [ -x /etc/init.d/cgroups ]; then
    rc-service cgroups start
fi
mkdir -p /sys/fs/cgroup
mountpoint -q /sys/fs/cgroup || mount -t cgroup2 none /sys/fs/cgroup

echo "--- Setting up physical disk storage ---"
if [ -b /dev/sda3 ]; then
    if ! blkid /dev/sda3 | grep -q 'TYPE="ext4"'; then
        echo "Formatting /dev/sda3 as ext4..."
        mkfs.ext4 -O ^has_journal -F /dev/sda3
    fi
    mkdir -p /mnt/data
    mount /dev/sda3 /mnt/data
    
    # Create persistent directories
    mkdir -p /mnt/data/k0s /mnt/data/bin
    
    # Symlink persistent k0s data
    mkdir -p /var/lib
    ln -sf /mnt/data/k0s /var/lib/k0s
fi

echo "--- Installing/Ensuring k0s ---"
if [ ! -f /mnt/data/bin/k0s ]; then
    echo "Downloading k0s..."
    curl -sSLf https://get.k0s.sh | sh
    cp /usr/local/bin/k0s /mnt/data/bin/k0s
else
    echo "k0s already exists on persistent disk, linking..."
    ln -sf /mnt/data/bin/k0s /usr/local/bin/k0s
fi

echo "--- Loading kernel modules ---"
modprobe overlay
modprobe br_netfilter

echo "--- Configuring k0s service ---"
# Always run install to recreate the OpenRC service in memory
k0s install controller --single --data-dir /var/lib/k0s --force

echo "--- Starting k0s ---"
rc-service k0scontroller start

echo "BOOTSTRAP COMPLETE: \$(date)"

# delete this hack
# otherwise this script will run on the system we newly installed
rm -f /etc/local.d/bootstrap.start
rm -f /etc/runlevels/default/local
EOF

# Turn on local service in busybox init
ln -sf /etc/init.d/local $sysroot/etc/runlevels/default/
cp bootstrap.start $sysroot/etc/local.d/
chmod +x $sysroot/etc/local.d/bootstrap.start
