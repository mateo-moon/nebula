#!/bin/sh

cat <<EOF > bootstrap.start
#!/bin/sh
exec > /var/log/bootstrap.log 2>&1
echo "BOOTSTRAP START: \$(date)"

# do the system installation
setup-interfaces -a
setup-keymap us us
setup-timezone -i UTC
setup-ntp chrony || true

true >/etc/apk/repositories
setup-apkrepos -1

echo "--- Installing dependencies ---"
apk add bash curl iptables util-linux iproute2 coreutils ethtool e2fsprogs

# Increase limits
ulimit -n 65536

# Mount cgroups (k0s needs this)
echo "--- Mounting cgroups ---"
mkdir -p /sys/fs/cgroup
mountpoint -q /sys/fs/cgroup || mount -t cgroup2 none /sys/fs/cgroup

echo "--- Setting up physical disk storage for k0s ---"
# Check if /dev/sda3 exists and format it if it doesn't have a filesystem
if [ -b /dev/sda3 ]; then
    if ! blkid /dev/sda3 | grep -q 'TYPE="ext4"'; then
        echo "Formatting /dev/sda3 as ext4..."
        mkfs.ext4 -O ^has_journal -F /dev/sda3
    fi
    echo "Mounting /dev/sda3 to /var/lib/k0s..."
    mkdir -p /var/lib/k0s
    mount /dev/sda3 /var/lib/k0s
fi

echo "--- Loading kernel modules ---"
modprobe overlay
modprobe br_netfilter

echo "--- Installing k0s ---"
curl -sSLf https://get.k0s.sh | sh
k0s install controller --single --data-dir /var/lib/k0s

echo "--- Starting k0s ---"
rc-service k0scontroller start

echo "BOOTSTRAP COMPLETE: \$(date)"

# delete this hack
# otherwise this script will run on the system we newly installed
rm -f /etc/local.d/bootstrap.start
rm -f /etc/runlevels/default/local
EOF

# Turn on local service in busybox init
ln -sf /etc/init.d/local $sysroot/etc/runlevels/default/
cp bootstrap.start $sysroot/etc/local.d/
chmod +x $sysroot/etc/local.d/bootstrap.start
